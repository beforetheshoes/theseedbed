name: Supabase DB Push

on:
  push:
    branches:
      - development
      - main
  workflow_dispatch: {}

concurrency:
  # Prevent concurrent pushes to the same branch/env (which can corrupt migration state).
  group: supabase-db-push-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  push-staging:
    if: github.ref_name == 'development'
    runs-on: ubuntu-latest
    environment: staging
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_STAGING_DB_PASSWORD }}
      SUPABASE_PROJECT_REF: kypwcksvicrbrrwscdze
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_WORKSPACE: tea-d58ltr9r0fns73fart0g
      RENDER_SERVICE_ID: srv-d58pjpre5dus73e3ghl0
      RENDER_HEALTH_URL: https://theseedbed-api-staging.onrender.com/api/v1/health
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify required secrets are configured
        run: |
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ] || [ -z "${SUPABASE_DB_PASSWORD:-}" ]; then
            echo "::error::Missing required secrets. Set SUPABASE_ACCESS_TOKEN and SUPABASE_STAGING_DB_PASSWORD (environment or repository secrets)."
            exit 1
          fi

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" --yes

      - name: Apply migrations to staging
        run: supabase db push --linked --password "$SUPABASE_DB_PASSWORD" --yes

      - name: Assert staging is fully migrated
        run: |
          output="$(supabase db push --dry-run --linked --password "$SUPABASE_DB_PASSWORD" --yes)"
          printf '%s\n' "$output"
          if printf '%s\n' "$output" | grep -q "Would push these migrations:"; then
            echo "::error::Staging still has pending migrations after push."
            exit 1
          fi

      - name: Install Render CLI
        run: |
          # Install a pinned Render CLI binary (more reliable than curl|sh).
          # Source: https://render.com/docs/cli
          RENDER_CLI_VERSION="2.8.0"
          asset="cli_${RENDER_CLI_VERSION}_linux_amd64.zip"
          curl -fsSL \
            "https://github.com/render-oss/cli/releases/download/v${RENDER_CLI_VERSION}/${asset}" \
            -o render.zip
          unzip -q render.zip
          sudo mv "cli_v${RENDER_CLI_VERSION}" /usr/local/bin/render
          render --version

      - name: Verify Render API key is configured
        run: |
          if [ -z "${RENDER_API_KEY:-}" ]; then
            echo "::error::Missing RENDER_API_KEY secret. Add it as a GitHub Actions secret (prefer environment-scoped)."
            exit 1
          fi

      - name: Select Render workspace
        run: render workspace set "$RENDER_WORKSPACE" --output text --confirm

      - name: Deploy staging API (Render)
        run: |
          render deploys create "$RENDER_SERVICE_ID" --commit "$GITHUB_SHA" --wait --output text --confirm

      - name: Smoke check staging API health
        run: |
          curl -fsS "$RENDER_HEALTH_URL" >/dev/null
          echo "Health check passed: $RENDER_HEALTH_URL"

  push-production:
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    environment: production
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
      SUPABASE_PROJECT_REF: aaohmjvcsgyqqlxomegu
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_WORKSPACE: tea-d58ltr9r0fns73fart0g
      RENDER_SERVICE_ID: srv-d58poa3e5dus73e3it8g
      RENDER_HEALTH_URL: https://theseedbed-api.onrender.com/api/v1/health
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify required secrets are configured
        run: |
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ] || [ -z "${SUPABASE_DB_PASSWORD:-}" ]; then
            echo "::error::Missing required secrets. Set SUPABASE_ACCESS_TOKEN and SUPABASE_PROD_DB_PASSWORD (environment or repository secrets)."
            exit 1
          fi

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" --yes

      - name: Apply migrations to production
        run: supabase db push --linked --password "$SUPABASE_DB_PASSWORD" --yes

      - name: Assert production is fully migrated
        run: |
          output="$(supabase db push --dry-run --linked --password "$SUPABASE_DB_PASSWORD" --yes)"
          printf '%s\n' "$output"
          if printf '%s\n' "$output" | grep -q "Would push these migrations:"; then
            echo "::error::Production still has pending migrations after push."
            exit 1
          fi

      - name: Install Render CLI
        run: |
          # Install a pinned Render CLI binary (more reliable than curl|sh).
          # Source: https://render.com/docs/cli
          RENDER_CLI_VERSION="2.8.0"
          asset="cli_${RENDER_CLI_VERSION}_linux_amd64.zip"
          curl -fsSL \
            "https://github.com/render-oss/cli/releases/download/v${RENDER_CLI_VERSION}/${asset}" \
            -o render.zip
          unzip -q render.zip
          sudo mv "cli_v${RENDER_CLI_VERSION}" /usr/local/bin/render
          render --version

      - name: Verify Render API key is configured
        run: |
          if [ -z "${RENDER_API_KEY:-}" ]; then
            echo "::error::Missing RENDER_API_KEY secret. Add it as a GitHub Actions secret (prefer environment-scoped)."
            exit 1
          fi

      - name: Select Render workspace
        run: render workspace set "$RENDER_WORKSPACE" --output text --confirm

      - name: Deploy production API (Render)
        run: |
          render deploys create "$RENDER_SERVICE_ID" --commit "$GITHUB_SHA" --wait --output text --confirm

      - name: Smoke check production API health
        run: |
          curl -fsS "$RENDER_HEALTH_URL" >/dev/null
          echo "Health check passed: $RENDER_HEALTH_URL"
