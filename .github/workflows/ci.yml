name: CI

on:
  pull_request:
    branches:
      - development
      - main
  push:
    branches:
      - main

jobs:
  staging-migration-guard:
    runs-on: ubuntu-latest
    environment: staging
    # Secrets are unavailable on forked PRs; skip in that case.
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'development' && github.event.pull_request.head.repo.fork == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Verify required secrets are configured
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_STAGING_DB_PASSWORD: ${{ secrets.SUPABASE_STAGING_DB_PASSWORD }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_STAGING_DB_PASSWORD" ]; then
            echo "::error::Missing required GitHub Actions secrets for staging migration guard. Set SUPABASE_ACCESS_TOKEN and SUPABASE_STAGING_DB_PASSWORD as repository secrets (Environment secrets may not be available to pull_request workflows)."
            exit 1
          fi
      - name: Verify staging migrations are applied
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_STAGING_DB_PASSWORD: ${{ secrets.SUPABASE_STAGING_DB_PASSWORD }}
        run: |
          supabase link --project-ref kypwcksvicrbrrwscdze --password "$SUPABASE_STAGING_DB_PASSWORD" --yes
          output="$(supabase db push --dry-run --password "$SUPABASE_STAGING_DB_PASSWORD" --linked --yes)"
          printf '%s\n' "$output"
          if printf '%s\n' "$output" | grep -q "Would push these migrations:"; then
            echo "::error::Staging database has pending migrations. Apply migrations (supabase db push) before merging/deploying API changes."
            exit 1
          fi

  api:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
      - name: Start Supabase
        run: make -C ../.. supabase-env
      - name: Export Supabase env
        run: |
          python - <<'PY'
          from pathlib import Path
          import os

          env_path = Path("../../.env")
          out_path = Path(os.environ["GITHUB_ENV"])
          lines = env_path.read_text(encoding="utf-8").splitlines()

          with out_path.open("a", encoding="utf-8") as handle:
              for line in lines:
                  line = line.strip()
                  if not line or line.startswith("#") or "=" not in line:
                      continue
                  key, _, value = line.partition("=")
                  if (value.startswith('"') and value.endswith('"')) or (
                      value.startswith("'") and value.endswith("'")
                  ):
                      value = value[1:-1]
                  handle.write(f"{key}={value}\n")
          PY
      - name: Install dependencies
        run: uv sync --extra dev --frozen
      - name: Lint
        run: uv run ruff check .
      - name: Format check
        run: uv run black --check .
      - name: Type check
        run: uv run mypy .
      - name: Apply migrations
        run: uv run alembic upgrade head
      - name: Unit tests
        run: uv run pytest
      - name: Build
        run: uv run python -m build

  web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: "10"
          run_install: false
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml
      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('apps/web/pnpm-lock.yaml') }}
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Cypress binary
        run: pnpm exec cypress install
      - name: Lint
        run: pnpm lint
      - name: Format check
        run: pnpm format:check
      - name: Unit tests
        run: pnpm test:unit
      - name: Cypress e2e
        run: pnpm test:e2e
      - name: Build
        run: pnpm build
